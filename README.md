# ChirpStack Docker example

This repository contains a skeleton to setup the [ChirpStack](https://www.chirpstack.io)
open-source LoRaWAN Network Server (v4) using [Docker Compose](https://docs.docker.com/compose/).

**Note:** Please use this `docker-compose.yml` file as a starting point for testing
but keep in mind that for production usage it might need modifications. 

## Directory layout

* `docker-compose.yml`: the docker-compose file containing the services
* `configuration/chirpstack`: directory containing the ChirpStack configuration files
* `configuration/chirpstack-gateway-bridge`: directory containing the ChirpStack Gateway Bridge configuration
* `configuration/mosquitto`: directory containing the Mosquitto (MQTT broker) configuration
* `configuration/postgresql/initdb/`: directory containing PostgreSQL initialization scripts

## Configuration

This setup is pre-configured for all regions. You can either connect a ChirpStack Gateway Bridge
instance (v3.14.0+) to the MQTT broker (port 1883) or connect a Semtech UDP Packet Forwarder.
Please note that:

* You must prefix the MQTT topic with the region.
  Please see the region configuration files in the `configuration/chirpstack` for a list
  of topic prefixes (e.g. eu868, us915_0, au915_0, as923_2, ...).
* The protobuf marshaler is configured.

This setup also comes with two instances of the ChirpStack Gateway Bridge. One
is configured to handle the Semtech UDP Packet Forwarder data (port 1700), the
other is configured to handle the Basics Station protocol (port 3001). Both
instances are by default configured for EU868 (using the `eu868` MQTT topic
prefix).

### Reconfigure regions

ChirpStack has at least one configuration of each region enabled. You will find
the list of `enabled_regions` in `configuration/chirpstack/chirpstack.toml`.
Each entry in `enabled_regions` refers to the `id` that can be found in the
`region_XXX.toml` file. This `region_XXX.toml` also contains a `topic_prefix`
configuration which you need to configure the ChirpStack Gateway Bridge
UDP instance (see below).

#### ChirpStack Gateway Bridge (UDP)

Within the `docker-compose.yml` file, you must replace the `eu868` prefix in the
`INTEGRATION__..._TOPIC_TEMPLATE` configuration with the MQTT `topic_prefix` of
the region you would like to use (e.g. `us915_0`, `au915_0`, `in865`, ...).

#### ChirpStack Gateway Bridge (Basics Station)

Within the `docker-compose.yml` file, you must update the configuration file
that the ChirpStack Gateway Bridge instance must used. The default is
`chirpstack-gateway-bridge-basicstation-eu868.toml`. For available
configuration files, please see the `configuration/chirpstack-gateway-bridge`
directory.

# Data persistence

PostgreSQL and Redis data is persisted in Docker volumes, see the `docker-compose.yml`
`volumes` definition.

## Requirements

Before using this `docker-compose.yml` file, make sure you have [Docker](https://www.docker.com/community-edition)
installed.

## Importing device repository

To import the [lorawan-devices](https://github.com/TheThingsNetwork/lorawan-devices)
repository (optional step), run the following command:

```bash
make import-lorawan-devices
```

This will clone the `lorawan-devices` repository and execute the import command of ChirpStack.
Please note that for this step you need to have the `make` command installed.

**Note:** an older snapshot of the `lorawan-devices` repository is cloned as the
latest revision no longer contains a `LICENSE` file.

## Usage

To start the ChirpStack simply run:

```bash
$ sudo docker-compose -f docker-compose.chirpstack.yml up -d
```

After all the components have been initialized and started, you should be able
to open http://localhost:8080/ in your browser.

##

The example includes the [ChirpStack REST API](https://github.com/chirpstack/chirpstack-rest-api).
You should be able to access the UI by opening http://localhost:8090 in your browser.

**Note:** It is recommended to use the [gRPC](https://www.chirpstack.io/docs/chirpstack/api/grpc.html)
interface over the [REST](https://www.chirpstack.io/docs/chirpstack/api/rest.html) interface.

## ChirpStack Manual Web UI Configuration

After launching the ChirpStack stack with `sudo docker-compose -f docker-compose.chirpstack.yml up -d`, follow the steps below to configure the API, device profiles, gateways, and applications through the ChirpStack web interface at [http://localhost:8080](http://localhost:8080).

### 1. Generate an Admin API Key
##
1. In the **Network Server** menu, select **API Keys**.
2. Click **Add** and enter a name for your API key.
3. Copy and securely store the API key generated by ChirpStack.

### 2. Generate an API Key
##
1. In the **Tenant** menu, select **API Keys**.
2. Click **Add** and enter a name for your API key.
3. Copy and securely store the API key generated by ChirpStack.

### 3. Create a Device Profile
##
1. In the right-side menu, go to **Device profiles**.
2. Click **Add device profile**.
3. Fill in a name for the profile.
4. Enable the following options:
   - âœ… Device supports OTAA
   - âœ… Device supports Class-B
   - âœ… Device supports Class-C
5. Go to the **Codec** tab and select **JavaScript functions**.
6. Paste the following JavaScript function into the **Code Functions** box. This function converts a hexadecimal payload to readable ASCII characters:

    ```javascript
    function decodeUplink(input) {
      var bytes = input.bytes;

      // Convert each byte to ASCII character
      var text = "";
      for (var i = 0; i < bytes.length; i++) {
        text += String.fromCharCode(bytes[i]);
      }

      return {
        data: {
          text: text
        }
      };
    }
    ```

7. Click **Submit** to confirm profile creation.

After submission, your new device profile should appear in the list.

### 4. Register a Gateway
##
1. In the right-side menu, go to **Gateways**.
2. Click **Add Gateway**.
3. Provide the following details:
   - **Name**: A descriptive name for your gateway.
   - **Gateway ID**: Enter the unique Gateway ID (usually printed on the device).
4. Click **Submit**.

The gateway should now be listed in the interface.

## Grafana Integration (Monitoring & Statistics)

After launching the grafana stack with `docker-compose -f docker-compose.grafana.yml up -d`, follow the steps below to configure **Grafana** to visualize ChirpStack data and logs using the integrated PostgreSQL database.

## Access Grafana UI

Open your browser and go to:  
**http://localhost:3000**

> Default login credentials:  
> **Username:** `admin`  
> **Password:** `admin`

You will be prompted to change your password at the first login.

## Configure PostgreSQL as a Data Source

1. Go to the **Connections** tab under **Alerting** in the left-hand menu.
2. Click on **Add new connection**.
3. In the search bar, type `PostgreSQL`.
4. Click on the **PostgreSQL** plugin.
5. Then click **Add new data source**.
6. Fill in the following fields:

| Field               | Value            |
|---------------------|------------------|
| Host URL            | `postgres:5432`  |
| Database name       | `chirpstack`     |
| Username            | `chirpstack`     |
| Password            | `chirpstack`     |
| TLS/SSL Mode        | `disable`        |
| PostgreSQL Version  | `14`             |

7. Click **Save & Test** to verify the connection.

## Import Dashboard

1. Go to the **Dashboards** tab in the left menu.
2. Click **Create dashboard**.
3. Then select **Import dashboard**.
4. Click **Upload JSON file**.
5. Upload the prebuilt dashboard file located at:  
   `./grafana/LoRaWAN-1751889408399.json`
6. After importing:
   - Open each panel.
   - Click on the **Run Query** button at least once to fetch and display the data.

## Registration Form Configuration (Streamlit App)
##
After launching the web stack with `sudo docker-compose -f docker-compose.web.yml up -d`, follow the steps below to allow users to register through the provided web application through the ChirpStack web interface at [http://localhost:8501](http://localhost:8501), you need to configure the secret parameters for the Streamlit app.

#### Steps:

#### 1. Edit the `secrets.toml` file

The `secrets.toml` file is located in the `./streamlit-app/` directory. Open it and fill in the following fields with your own values:  

```toml
SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 465
SMTP_LOGIN = "xxxxx@gmail.com"
SMTP_PASSWORD = "App password generate by google"  
TENANT_ID = "Your ChirpStack Tenant ID" 
DEVICE_Profile_ID = "The Device Profile ID created earlier"
CHIRPSTACK_API_TOKEN = "API token generated in the tenant API Keys section"
CHIRPSTACK_ADMIN_API_TOKEN = "API token generated in the Network Server API Keys section"

```
ðŸ’¡ Notes:

  - Use an app-specific password if your Gmail account has two-factor authentication enabled.
  - The values for APPLICATION_ID and DEVICE_PROFILE_ID can be found in the ChirpStack web interface under Applications and Device Profiles, respectively.
  - The CHIRPSTACK_API_TOKEN and the CHIRPSTACK_ADMIN_API_TOKEN are the token generated during the API Key step.

#### 2. Restart the `streamlit_app` service

Once the `secrets.toml` file has been updated and saved, restart the `streamlit_app` service using the following command :

```Docker 
sudo docker-compose -f docker-compose.web.yml restart
```


